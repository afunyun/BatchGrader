# Code Quality Action Items

### General Code Quality

1. **Docstrings**

   - ✓ Ensure all functions/classes have comprehensive docstrings.
   - ✓ **Action:** Reviewed and improved docstrings in `src/file_processor.py`, `src/token_tracker.py`, and `src/logger.py`. Other core modules were checked and found to have good docstring coverage.

2. **File Operations**

   - ✓ Use `pathlib.Path` consistently for all file operations.
   - ✓ **Action:** Refactored `src/file_utils.py`, `src/file_processor.py`, `src/utils.py`, `src/log_utils.py`, and `src/input_splitter.py` to replace `os.path` and related `os` functions with `pathlib.Path` equivalents for path manipulation and file system interactions.

3. **Type Hints**

   - ✓ Maintain and expand type hint coverage.
   - ✓ **Action:** Reviewed and improved type hints in several modules including `src/token_tracker.py`, `src/input_splitter.py`, and `src/utils.py` by replacing `Any` with more specific types (e.g., `Optional[tiktoken.Encoding]`, `Optional[Callable[[pd.Series], int]]`, `List[Dict[str, Any]]`) and adding missing hints. This is an ongoing effort.

4. **Logging**
   - ✓ Keep logging user-friendly and consistent (preferably using `BatchGraderLogger` with `RichHandler`).
   - ✓ **Action:** Standardized on `logging.getLogger(__name__)` for all modules, with root logger configured by `logger.setup_logging()` using `RichHandler` for console and a `FileHandler`. (Corresponds to Specific Area item #2).

### Individual File/Line Action Items

1. **src/batch_runner.py:47**

   - ✓ _Code refinement:_ Encoder acquisition is duplicated.
   - ✓ **Action:** Refactored encoder acquisition into a shared utility (`utils.get_encoder()`), used everywhere needed.

2. **src/input_splitter.py:199**

   - ✓ _Performance:_ Avoid using `DataFrame.iterrows()` for chunking large DataFrames.
   - ✓ **Action:** Replaced `iterrows()` with more efficient `itertuples()` for better performance.

3. **src/input_splitter.py:233**

   - ✓ _Edge case:_ Both `token_limit` and `row_limit` can be `None`, causing unintended chunking.
   - ✓ **Action:** Added comprehensive validation to ensure at least one limit is set and all parameters are valid.

4. **src/file_processor.py:550**

   - ✓ _Data Handling:_ Need to handle case where both 'id' and 'custom_id' columns exist.
   - ✓ **Action:** Improved column handling logic to:
     - Keep existing 'custom_id' when both columns exist
     - Only rename 'id' to 'custom_id' when needed
     - Only drop 'custom_id' if it was generated by us
     - Added proper logging for all column operations

5. **src/file_processor.py:557**

   - ✓ _Error Handling:_ Add more granular error handling for file operations.
   - ✓ **Action:** Implemented specific error types and recovery strategies:
     - Created custom exception hierarchy in exceptions.py
     - Added specific error handling for file operations
     - Improved error messages and logging
     - Added proper exception documentation

6. **src/batch_runner.py:95**

   - ✓ _Logging:_ Add more context to error messages.
   - ✓ **Action:** Enhanced error messages with:
     - File metadata (size, last modified)
     - Configuration state
     - Error type information
     - Processing duration
     - Improved user guidance in error messages

7. **src/batch_job.py:80**

   - ✓ _Monitoring:_ Add progress tracking for long-running jobs.
   - ✓ **Action:** Implement progress tracking and ETA estimation.

8. **API Key Handling**

   - ✓ _Security:_ Ensure API keys are handled securely.
   - ✓ **Action:** Reviewed API key handling. Current practices (preferring environment variables, masking keys in logs) are satisfactory. No hardcoded sensitive keys found.

### Specific Areas and Potential Improvements

1. **Configuration Management**

   - ✓ _Observation:_ `token_tracker.py` might have missed dependency injection refactor.
   - ✓ _Recommendation:_ Ensure `token_tracker.py` receives configuration via dependency injection.
   - ✓ **Action:** Refactored `token_tracker.py` to accept path configurations (for log files, pricing CSV) as arguments to its functions, removing global path definitions. Paths are now sourced from `constants.py` and passed by callers.

2. **Logging**

   - ✓ _Observation:_ Inconsistencies in logger initialization across modules.
   - ✓ _Recommendation:_ Standardize logger usage to ensure consistent formatting and handler setup.
   - ✓ **Action:** Refactored `src/logger.py` to provide a `setup_logging()` function that configures the root logger. All modules now use `logging.getLogger(__name__)` for consistent logger instances. `setup_logging()` is called from `cli.py`.

3. **Error Handling and Input Validation**

   - ✓ _Observation:_ Broad exception in `batch_runner.py` logs a CRITICAL ERROR message.
   - ✓ _Recommendation:_ Catch and handle specific exceptions where possible for better context.
   - ✓ **Action:** Added specific `IOError`/`OSError` handling in `batch_runner.py`'s main processing loop. Enhanced `cli.py`'s top-level error handler to specifically manage `KeyboardInterrupt` and `SystemExit`.

4. **Constants and Paths**

   - ✓ _Observation:_ `token_tracker.py` defines paths directly.
   - ✓ _Recommendation:_ Centralize path definitions in `constants.py` for consistency.
   - ✓ **Action:** Addressed as part of the `token_tracker.py` refactor (see item #1 in Specific Areas). Paths for token tracking (logs, pricing CSV) were moved to `constants.py` and are now passed as arguments.

5. **Docstrings and Comments**

   - ✓ _Observation:_ Some complex logic lacks detailed comments.
   - ✓ _Recommendation:_ Add inline comments for complex functions/logic blocks.
   - ✓ **Action:** Added inline comments to the concurrent processing logic in `src/file_processor.py` (specifically `process_file_concurrently` and `_pfc_process_completed_future`) to clarify control flow, error handling, and state management.

6. **Testing**

   - ✓ _Observation:_ Comprehensive test suite exists.
   - ✓ _Recommendation:_ Expand tests for edge cases and error conditions as features are added.
   - ✓ **Action:** Reviewed. The recommendation is noted. Future test expansions should consider dedicated tests for features like `force_chunk_count` in `input_splitter.py` and various error/completion states in the concurrent file processing logic within `file_processor.py`.

7. **Code Duplication / Refactoring Opportunities**

   - ✓ _Observation:_ Refactoring has reduced duplication.
   - ✓ _Recommendation:_ Consolidate common logic into helper functions where appropriate.
   - ✓ **Action:** Reviewed. Significant refactoring, such as the creation of `file_processor.py` to centralize processing logic and `utils.py` for common utilities (e.g., `get_encoder`), has already addressed major duplication. Future refactoring can be done opportunistically as the codebase evolves.

8. **src/input_splitter.py:65**
   - ✓ _Validation:_ Need to handle edge case where both `token_limit` and `row_limit` can be `None`.
   - ✓ **Action:** Added validation to ensure at least one of token_limit, row_limit, or force_chunk_count is set.
